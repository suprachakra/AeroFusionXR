name: ğŸ›¡ï¸ Quality Gates & Clean Architecture Enforcement

on:
  push:
    branches: [main, develop, feature/*, hotfix/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly security scans
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # ============================================================================
  # Phase 1: Fast Feedback Loop (< 5 minutes)
  # ============================================================================
  
  lint-and-format:
    name: ğŸ§¹ Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ§¹ ESLint Check
        run: npm run lint
      
      - name: ğŸ’… Prettier Format Check
        run: npm run format:check
      
      - name: ğŸ”§ TypeScript Type Check
        run: npm run typecheck

  duplication-detection:
    name: ğŸ” Zero Duplication Enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ” Advanced Duplication Detection
        run: npm run quality:duplication
      
      - name: ğŸ“Š Upload Duplication Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: duplication-report
          path: reports/duplication-report.json
          retention-days: 30

  dependency-validation:
    name: ğŸ—ï¸ Architecture Boundary Enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ—ï¸ Validate Service Dependencies
        run: npm run quality:dependencies
      
      - name: ğŸ“Š Upload Dependency Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: reports/dependency-report.json
          retention-days: 30

  # ============================================================================
  # Phase 2: Comprehensive Testing (< 15 minutes)
  # ============================================================================
  
  unit-tests:
    name: ğŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-format, duplication-detection, dependency-validation]
    
    strategy:
      matrix:
        workspace: [packages, services]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ§ª Run Tests with Coverage
        run: npm run test:coverage
        env:
          CI: true
      
      - name: ğŸ“Š Coverage Threshold Check
        run: |
          if [ "${{ matrix.workspace }}" = "packages" ]; then
            npx istanbul-threshold-checker --coverage coverage/coverage-summary.json --threshold 90
          else
            npx istanbul-threshold-checker --coverage coverage/coverage-summary.json --threshold 80
          fi
      
      - name: ğŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: ${{ matrix.workspace }}
          name: ${{ matrix.workspace }}-coverage
          fail_ci_if_error: true

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: aerofusionxr_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ”— Run Integration Tests
        run: npm run test:e2e
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/aerofusionxr_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

  # ============================================================================
  # Phase 3: Security & Performance (< 10 minutes)
  # ============================================================================
  
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint-and-format]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ”’ NPM Security Audit
        run: npm audit --audit-level moderate
      
      - name: ğŸ›¡ï¸ Snyk Security Scan
        run: npx snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ“Š CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: typescript, javascript

  performance-tests:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [unit-tests]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: âš¡ Run Performance Tests
        run: npm run performance:test
      
      - name: ğŸ“Š Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: reports/performance-report.json
          retention-days: 30

  # ============================================================================
  # Phase 4: Build & Container Validation (< 8 minutes)
  # ============================================================================
  
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [duplication-detection, dependency-validation]
    
    strategy:
      matrix:
        target: [packages, services, clients]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ—ï¸ Build ${{ matrix.target }}
        run: npm run build:${{ matrix.target }}
      
      - name: ğŸ“¦ Verify Build Artifacts
        run: |
          echo "ğŸ” Verifying build artifacts for ${{ matrix.target }}..."
          find ${{ matrix.target }} -name "dist" -type d | head -5
          echo "âœ… Build artifacts verified"

  container-security:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-validation]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t aerofusionxr:latest .
          docker build -t aerofusionxr:${{ github.sha }} .
      
      - name: ğŸ›¡ï¸ Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'aerofusionxr:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
      
      - name: ğŸ“Š Upload Trivy Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # Phase 5: Quality Gate Summary (Final Decision)
  # ============================================================================
  
  quality-gate-summary:
    name: ğŸ¯ Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [
      lint-and-format,
      duplication-detection,
      dependency-validation,
      unit-tests,
      integration-tests,
      security-scan,
      performance-tests,
      build-validation,
      container-security
    ]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
      
      - name: ğŸ“‹ Generate Quality Summary
        run: |
          echo "# ğŸ¯ AeroFusionXR Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§¹ **Lint & Format**: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **Duplication Check**: ${{ needs.duplication-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ **Dependencies**: ${{ needs.dependency-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª **Unit Tests**: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **Integration Tests**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **Performance**: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ **Build**: ${{ needs.build-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ³ **Container Security**: ${{ needs.container-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if all critical gates passed
          if [[ "${{ needs.lint-and-format.result }}" == "success" ]] && \
             [[ "${{ needs.duplication-detection.result }}" == "success" ]] && \
             [[ "${{ needs.dependency-validation.result }}" == "success" ]] && \
             [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
             [[ "${{ needs.build-validation.result }}" == "success" ]]; then
            echo "## âœ… **QUALITY GATE PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "All critical quality checks have passed. This code meets AeroFusionXR excellence standards." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ **QUALITY GATE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical quality checks have failed. Please review and fix before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Quality Gate Passed! Code is ready for deployment."
          echo "ğŸ“Š All quality metrics are within acceptable thresholds."
          echo "ğŸš€ This build meets AeroFusionXR enterprise standards."

  # ============================================================================
  # Optional: Nightly Deep Analysis
  # ============================================================================
  
  nightly-deep-scan:
    name: ğŸŒ™ Nightly Deep Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ” Deep Code Analysis
        run: |
          echo "ğŸŒ™ Running nightly deep analysis..."
          npm run quality:all
          npm run analyze:bundle
          npm run metrics
      
      - name: ğŸ“Š Generate Comprehensive Report
        run: |
          echo "ğŸ“Š Generating comprehensive quality report..."
          # Add comprehensive reporting logic here
      
      - name: ğŸ“§ Send Report
        # Add notification logic for teams
        run: echo "ğŸ“§ Deep analysis complete. Report sent to development teams." 